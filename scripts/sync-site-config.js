const fs = require("fs");
const path = require("path");

const DIRECTUS_URL = process.env.DIRECTUS_URL;
const DIRECTUS_TOKEN = process.env.DIRECTUS_TOKEN;
const SITE_ID = process.env.SITE_ID;

function requireEnv(name, value) {
  if (!value) {
    throw new Error(`Missing required env: ${name}`);
  }
}

async function directusRequest(pathname) {
  const url = `${DIRECTUS_URL.replace(/\/+$/, "")}${pathname}`;
  const res = await fetch(url, {
    headers: {
      Authorization: `Bearer ${DIRECTUS_TOKEN}`,
      "Content-Type": "application/json",
    },
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Directus request failed: ${res.status} ${text}`);
  }

  return res.json();
}

function buildSiteConfigFile(config) {
  const json = JSON.stringify(config, null, 2);
  return [
    "// Auto-generated by scripts/sync-site-config.js",
    "export const siteConfig = " + json + " as const",
    "",
    "export type SiteConfig = typeof siteConfig",
    "",
  ].join("\n");
}

async function main() {
  requireEnv("DIRECTUS_URL", DIRECTUS_URL);
  requireEnv("DIRECTUS_TOKEN", DIRECTUS_TOKEN);
  requireEnv("SITE_ID", SITE_ID);

  const response = await directusRequest(
    `/items/sites/${SITE_ID}?fields[]=site_config`
  );
  const siteConfig = response?.data?.site_config;

  if (!siteConfig || typeof siteConfig !== "object") {
    console.log("No site_config found. Skipping site.config.ts update.");
    return;
  }

  const targetPath = path.join(process.cwd(), "lib", "site.config.ts");
  const contents = buildSiteConfigFile(siteConfig);
  fs.writeFileSync(targetPath, contents, "utf8");

  console.log(`Updated ${targetPath}`);
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
